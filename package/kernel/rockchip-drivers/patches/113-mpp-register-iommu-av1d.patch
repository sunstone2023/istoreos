From 09aaf6b40a083dc3a9f2400a493d2145212a6246 Mon Sep 17 00:00:00 2001
From: jjm2473 <jjm2473@gmail.com>
Date: Tue, 18 Mar 2025 22:26:06 +0800
Subject: [PATCH] mpp: register iommu_av1d driver

---
 drivers/video/rockchip/mpp/mpp_common.h  | 2 ++
 drivers/video/rockchip/mpp/mpp_service.c | 8 ++++++++
 2 files changed, 10 insertions(+)

diff --git a/drivers/video/rockchip/mpp/mpp_common.h b/drivers/video/rockchip/mpp/mpp_common.h
index fdf893c..c61ac08 100644
--- a/drivers/video/rockchip/mpp/mpp_common.h
+++ b/drivers/video/rockchip/mpp/mpp_common.h
@@ -853,4 +853,6 @@ extern struct platform_driver rockchip_av1dec_driver;
 extern struct platform_driver rockchip_jpgenc_driver;
 extern struct platform_driver rockchip_vdpp_driver;
 
+extern struct platform_driver rockchip_av1_iommu_driver;
+
 #endif
diff --git a/drivers/video/rockchip/mpp/mpp_service.c b/drivers/video/rockchip/mpp/mpp_service.c
index 642e159..5844b01 100644
--- a/drivers/video/rockchip/mpp/mpp_service.c
+++ b/drivers/video/rockchip/mpp/mpp_service.c
@@ -101,6 +101,14 @@ static int mpp_add_driver(struct mpp_service *srv,
 		     &srv->grf_infos[type],
 		     grf_name);
 
+#if IS_ENABLED(CONFIG_ROCKCHIP_MPP_AV1DEC)
+	if (type == MPP_DRIVER_AV1DEC) {
+		ret = platform_driver_register(&rockchip_av1_iommu_driver);
+		if (ret)
+			return ret;
+	}
+#endif
+
 	ret = platform_driver_register(driver);
 	if (ret)
 		return ret;
-- 
2.46.0

